<!doctype html>
<html lang="en">
	<head>
		<title>AWSM TODO</title>
		<meta name="description" content="The most ridiculous TODO list ever created.">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link rel="icon" href="/img/favicon@2x.png">
		<link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="/css/font-awesome.min.css">
		<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

		<style>
			html, body {
				background: #000;
				color: #FFF;
				font-family: "Open Sans";
				font-size: 20px;
				margin: 0;
				padding: 0 20px 30px 20px;
			}

			h1 {
				font-size: 50px;
				margin: 0;
				padding: 0;
			}

			h2 {
				font-size: 14px;
				text-transform: uppercase;
				color: #666;
				letter-spacing: 2px;
				font-weight: bold;
				margin: 0 0 5px 0;
				padding: 0;
			}

			h3 {
				font-size: 18px;
				text-transform: uppercase;
				color: #666;
				letter-spacing: 2px;
				font-weight: bold;
				margin: 30px 0 20px 0;
				padding: 0;
			}

			p {
				margin: 0;
				padding: 0;
				line-height: 30px;
				height: 30px;
				overflow: hidden;
			}

			.assigned {
				color: #666;
				font-weight: bold;
				font-size: 16px;
			}

			i.fa {
				color: #191919;
				padding: 0 20px 0 0;
				font-size: 44px;
				-webkit-transition: color 300ms ease-in-out;
			}

			.overflow {
				overflow: hidden;
			}

			.checklist {
				margin: 0;
				padding: 0;
				overflow: hidden;
			}

			.checkbox {
				display: block;
				margin: 0 !important;
				padding: 10px;
				cursor: pointer;
				overflow: hidden;
				-webkit-transition: background 300ms ease-in-out;
				-webkit-border-radius: 14px;
				-moz-border-radius: 14px;
				-o-border-radius: 14px;
				border-radius: 14px;
			}

			.checkbox:hover {
				background: #111;
			}

			.checkbox:hover i.fa {
				color: #333;
			}

			.checkbox.faded h4 {
				color: #444;
			}

			.checkbox.faded i.fa {
				color: #F09;
				-webkit-animation: color-pulse 30s linear infinite alternate;
			}

			.progress-bar {
				position: fixed;
				bottom: 0px;
				left: 0px;
				width: 100%;
				height: 40px;
				background: #111;
			}

			.progress-inner {
				height: 100%;
				width: 0%;
				background: #f09;
				position: relative;
				-webkit-transition: width 500ms ease-in-out;
				-webkit-animation: background-pulse 30s linear infinite alternate;
			}

			.progress-percent {
				color: #666;
				height: 100%;
				width: 80px;
				position: absolute;
				text-align: center;
				right: -80px;
				top: 0px;
				line-height: 40px;
				font-size: 20px;
			}

			.pump-it {
				color: #FFF;
				font-size: 210px;
				font-weight: bold;
				text-align: center;
				line-height: 400px;
				height: 400px;
				width: 100%;
				position: fixed;
				top: 50%;
				left: 0px;
				margin-top: -200px;
				-webkit-transform: scale3d(1, 1, 1);
				-webkit-animation: size-pulse 200ms ease-in-out infinite;
			}

			.success-msg {
				display: none;
			}

			.active {
				display: block!important;
			}
			
			@-webkit-keyframes background-pulse { 
				20%  { background-color: #FFE019; }
				40%  { background-color: #14BFCC; }
				60%  { background-color: #B21272; }
				80%  { background-color: #09A7B2; }
				100% { background-color: #F09; }
			}

			@-webkit-keyframes color-pulse { 
				20%  { color: #FFE019; }
				40%  { color: #14BFCC; }
				60%  { color: #B21272; }
				80%  { color: #09A7B2; }
				100% { color: #F09; }
			}

			@-webkit-keyframes size-pulse { 
				50%  { -webkit-transform: scale3d(1.2, 1.2, 1.2); }
			}

			#splash {
				position: fixed;
				top: 0px;
				left: 0px;
				width: 100%;
				height: 100%;
				background: #f09;
				-webkit-animation: background-pulse 3.5s linear infinite alternate;
				text-align: center;
				line-height: 100%;
				z-index: 2;
				opacity: 1;
			}

			#splash h1 {
				position: absolute;
				top: 50%;
				height: 100px;
				width: 100%;
				line-height: 100px;
				margin-top: -50px;
				font-size: 90px;
			}

			.fade-out {
			    -webkit-animation: fadeOut ease-in 500ms forwards 700ms;
			    -moz-animation:    fadeOut ease-in 500ms forwards 700ms;
			    animation:         fadeOut ease-in 500ms forwards 700ms;
			}

			@-webkit-keyframes fadeOut { from { opacity:1; } to { opacity:0; } }
			@-moz-keyframes fadeOut { from { opacity:1; } to { opacity:0; } }
			@keyframes fadeOut { from { opacity:1; } to { opacity:0; } }

			.win-msg {
				position: fixed;
				top: 0px;
				left: 0px;
				width: 100%;
				height: 100%;
				background: #f09;
				-webkit-animation: background-pulse 2s linear infinite alternate;
				color: #FFF;
				display: none;
			}
		</style>
	</head>
	<body>

		<div id="splash" class="fade-out">
			<h1>AWSM List 1.0</h1>
		</div>

		<div id="content" class="row">

			<div id="doing">
				<h3>DOING</h3>
				<ul class="checklist">
					<li class="checkbox tpl col-lg-6">
						<div class="pull-left"><i class="fa fa-circle-o"></i></div>
						<div class="overflow">
							<h2></h2>
							<p></p>
							<div class="assigned"></div>
						</div>
						<div class="clearfix"></div>
					</li>
				</ul>
			</div>

			<div id="done">
				<h3>DONE</h3>
				<ul class="checklist">
					<li class="checkbox tpl col-lg-4 faded">
						<div class="pull-left"><i class="fa fa fa-check-circle-o"></i></div>
						<div class="overflow">
							<h4></h4>
						</div>
						<div class="clearfix"></div>
					</li>
				</ul>
			</div>

			<div id="progress">
				<div class="progress-bar">
					<div class="progress-inner">
						<div class="progress-percent">30%</div>
					</div>
				</div>
				<div class="success-msg"></div>
				<div class="win-msg"></div>
				<audio class="player" preload></audio>
			</div>
		</div>


		<!-- zerver:/js/main.min.js -->
		<script src="/js/libs/jquery.2.0.3.min.js"></script>
		<script src="/js/libs/bootstrap.3.2.0.min.js"></script>
		<script src="/js/libs/underscore.1.5.2.min.js"></script>
		<script src="/js/libs/backbone.1.1.2.min.js"></script>
		<script src="/js/libs/db.js"></script>
		<!-- /zerver -->

		<script>

			var listView = Backbone.View.extend({
				initialize: function(options) {
					var _this = this;

					if (options.collection) this.collection = options.collection;

					this.$itemTpl = this.$el.find('li.tpl');
					this.$itemTpl.remove();

					// bind UI to collection events
					if(this.collection) {
						this.listenTo(this.collection, 'add', this.addItem);
						this.listenTo(this.collection, 'remove', this.removeItem);

						var frag = document.createDocumentFragment();
						_.each(_this.collection.models, function(model) {
							frag.appendChild(_this.renderItem(model)[0]);
						});

						this.$el.find("ul").html(frag);
					}
				},
				renderItem: function(model) {
					var $node = this.$itemTpl.clone();
					$node.attr("data-id", model.get("id"));
					$node.find("h2").text(model.get("title"));
					$node.find("p").html(model.get("para") + " <strong><small>" + model.get("assigned") + "</small></strong>");
					if (model.get("checked")) {
						$node.addClass("faded")
						$node.find("i.fa").replaceWith("<i class='fa fa-check-circle-o white'></i>");
					}
					return $node;
				},
				addItem: function (model) {
					this.$el.removeClass("hidden").find("ul").append(this.renderItem(model));
					/*$('html, body').animate({
				        scrollTop: this.$el.find(".checkbox[data-id='"+ model.get("id") +"']").offset().top
				    }, 500);*/
				},
				removeItem: function (model) {
					this.$el.find(".checkbox[data-id='"+ model.get("id") +"']").remove();
					if (this.collection.length == 0) this.$el.addClass("hidden")
				},
				events: {
					"click .checkbox" : "toggleChecked",
				},
				toggleChecked: function(e) {
					var $item = $(e.currentTarget);
					var model = this.collection.get($item.attr('data-id'));
					var _this = this;
					model.set("checked", !model.get("checked"));
				},
			});

			var doneView = listView.extend({
				el: "#done",
				renderItem: function(model) {
					var $node = this.$itemTpl.clone();
					$node.attr("data-id", model.get("id"));
					$node.find("h4").text(model.get("title"));
			
					return $node;
				},
			});

			var doingView = listView.extend({
				el: "#doing",
				renderItem: function(model) {
					var $node = this.$itemTpl.clone();
					$node.attr("data-id", model.get("id"));
					$node.find("h2").text(model.get("title"));

					var para = model.get("para");
					if (para.length > 50) para = para.slice(0, 50) + "...";

					$node.find("p").text(para);
					$node.find(".assigned").html("<small>" + model.get("assigned") + "</small>");

					return $node;
				},
			});

			var progressView = Backbone.View.extend({
				el: "#progress",
				percent: 0,
				initialize: function(options) {
					this.doing 		  = options.doing;
					this.done  		  = options.done;
					this.successText  = options.successText;
					this.successAudio = options.successAudio;
					this.winText  	  = options.winText;
					this.winAudio 	  = options.winAudio;
					this.player		  = $('.player');

					if (this.doing) this.listenTo(this.doing, 'add', this.update);
					if (this.done)  this.listenTo(this.done, 'add', this.update);
					this.update({}, { silent: true });
				},
				update: function(model, options) {
					var total   = doing.length + done.length,
						percent = parseInt((100/total) * done.length) || 0;

					// update the progress indicator
					this.$el.find('.progress-inner').css("width", percent + "%");
					this.$el.find('.progress-percent').text(percent + "%");

					// show a success message
					if (!options.silent && percent == 100) this.complete();
					else if (!options.silent && this.percent < percent) this.checked();

					// keep track of progress
					this.percent = percent;
				},
				checked: function() {
					var _this = this,
						i 	  = _.random(0, this.successText.length-1),
						x 	  = _.random(0, this.successAudio.length-1);

					// play a song
					this.playTrack(this.successAudio[x]);

					// show some text
					this.$el.find('.success-msg').html("<span class='pump-it'>" + this.successText[i] + "</span>").addClass('active');

					this.player.on('ended', function() {
						_this.$el.find('.success-msg').removeClass('active');
					});
				},
				complete: function() {
					var _this = this;

					// play a song
					this.playTrack(this.winAudio);

					// show some text
					this.$el.find('.win-msg').html("<span class='pump-it'>" + this.winText + "</span>").addClass('active');

					this.player.on('ended', function() {
						_this.$el.find('.win-msg').removeClass('active');
					});
				},
				playTrack: function(track) {
					var source= document.createElement('source');
					if (this.player[0].canPlayType('audio/mpeg;')) {
					    source.type= 'audio/mpeg';
					    source.src= '/audio/'+ track +'.mp3';
					} else {
					    source.type= 'audio/ogg';
					    source.src= '/audio/'+ track +'.ogg';
					}

					this.player.empty();
					this.player[0].appendChild(source);
					this.player[0].load();
					this.player[0].play();
				}
			});

			var task = Backbone.Model.extend({
				validate: function(attrs, options) {
					if (!attrs || !attrs.title || !attrs.para || !attrs.assigned) {
						var msg = "missing required fields";
						console.error(msg);
				      	return msg;
				    }
				    if (attrs.para.length > 50) {
				    	var msg = "para is too long";
						console.error(msg);
				      	return msg;
				    }
				},
			});

			var collection = Backbone.Collection.extend({
				storageKey: "AWSM-TODO",
				model: task,
				initialize: function(models, options) {
					if (options.storageKey) this.storageKey = options.storageKey;
					
					// setup event listeners
					this.on("add", this.saveToDB, this);
					this.on("remove", this.saveToDB, this);
				},
				saveToDB: function(model, val, options) {
					DB.write(this.storageKey, this.models);
				},
			});

			var doing = new collection(DB.read('AWSM-doing'), { storageKey: 'AWSM-doing' }),
				done  = new collection(DB.read('AWSM-done'),  { storageKey: 'AWSM-done'  });

			doing.on("change:checked", function(model) {
				doing.remove(model);
				done.add(model);
			});

			done.on("change:checked", function(model) {
				done.remove(model);
				doing.add(model);
			});

			new doingView({ collection: doing });
			new doneView({ collection: done });
			new progressView({ 
				doing 		 : doing,
				done  	     : done,
				successText  : ["Eff Yeah!", "Oh Snap!", "SHOTS!"],
				successAudio : ["final-countdown", "Shots"],
				winText      : "MONEY!",
				winAudio 	 : ["Shots"],
			});

			window.todoAPI = {
				addItem : function(payload) {
					payload['id'] = doing.length + 1;
					payload['created'] = new Date().getTime();
					var model = new task();
					model.set(payload, { validate:true });
					doing.add(model);
				},
				removeDoingItem : function(model_id) {
					var model = doing.get(model_id);
					doing.remove(model);
				},
				removeDoneItem : function(model_id) {
					var model = done.get(model_id);
					done.remove(model);
				},
			}

			setTimeout(function() {
				$('#splash').addClass("hidden");
			}, 1200);

		</script>

	</body>
</html>
